---
title: "Bees"
author: "Fabricio Albuquerque"
date: "2022-09-23"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(scales)
library(lubridate)
```


# What is causing bee mortality in the USA?

Bees are some of nature's most important pollinating species. In addition to this service, bees provide honey and propolis contributing to people's health and generating income for many bee keepers.

In this work we' ll see what has caused the death of honey bees in the United States. Here, we will explore the following questions:

- Which states have had highest bee colony loss rates; 
- in which season (summer or winter) did the highest bee losses occur;
- what are the main causes of bee death 

```{r}
#colony <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-11/colony.csv')
#stressor <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-11/stressor.csv')
```

```{r}
colony <- readr::read_csv("data-raw/colony.csv")
stressor <- readr::read_csv("data-raw/stressor.csv")
```

```{r}
#colony loss
colony_loss <- colony |> 
  group_by(year) |> 
  summarise(colony_lost_ttl = sum(colony_lost, na.rm = T),
         #sd = sd(colony_lost, na.rm = T)
         ) |> 
  mutate(yearr = make_date(year))
```

```{r}
my_palette <- list("gray" = "#655e59",
                   "yellow" = "#eec04b",
                   "orange" = "#d48c14",
                   "brown" = "#714925",
                   "black" = "#43382f")
```



```{r}
colony_loss |> 
  ggplot(aes(x = yearr, y = colony_lost_ttl)) +
  geom_col(fill = my_palette$yellow) +
  scale_x_date( NULL,
    breaks = scales::breaks_width("1 year"), 
    labels = scales::label_date_short()) +
  scale_y_continuous("Total colonies lost",
                     limits = c(0, 4e6),
                     labels = label_number(
                       suffix = " M", 
                       scale = 1e-6),
                     expand = c(0, 0)) +
  #geom_hline(yintercept = 0) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank()) 
```



```{r}
colony_month <- colony |> 
  select(year, months, colony_lost_pct) |> 
  separate(months, into = c("month1")) |> 
  mutate(seasons = case_when(
    month1 == "January" ~ "winter",
    month1 == "April" ~ "spring",
    month1 == "July" ~ "summer",
    month1 == "October" ~ "autumn"
  )) |> 
  drop_na() |> 
  mutate(year = as.character(year)) |> 
  group_by(year, seasons) |> 
  summarise(season_loss = round(mean(colony_lost_pct, na.rm = T), 1))

anual_loss <- colony_month |> 
  group_by(year) |> 
  summarise(season_loss = sum(season_loss)) |> 
  mutate(seasons = "anual loss")

bee_lost <- full_join(colony_month, anual_loss) 
bee_lost$seasons <-  fct_relevel(bee_lost$seasons, "anual loss", after = Inf)
  

```

```{r}
ggplot(bee_lost) +
   geom_bar(aes(x = as.character(year), 
                y = season_loss, 
                fill = seasons),
           stat = "identity", 
           position = "dodge",
           width = .9) +
  scale_fill_manual(values = c(my_palette$gray, my_palette$yellow, 
                               my_palette$orange,
                               my_palette$brown, my_palette$black),
                    limits = c("autumn", "spring", 
                               "summer", "winter", 
                               "anual loss"),
                    labels = c("Autumn loss", "Spring loss", 
                               "Summer loss", "Winter loss", 
                               "Anual loss")) +
  scale_y_continuous(limits = c(0, 50),
                     expand = c(0, 0)) +
  labs(x = " ",
       y = "Loss (%)") +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "top",
        panel.grid.minor.y = element_blank())



```

```{r}
stressor |> 
  select(year, stressor, stress_pct) |> 
  group_by(year, stressor) |> 
  summarise(stres_by_year = round(mean(stress_pct, na.rm =T), 1)) |> 
  ggplot() +
  geom_bar(aes(x = as.character(year), 
                y = stres_by_year, 
                fill = stressor),
           stat = "identity", 
           position = "dodge",
           width = .9) +
  scale_fill_manual(values = c("#bdbdbd", my_palette$gray, my_palette$yellow, 
                               my_palette$orange,
                               my_palette$brown, my_palette$black)) +
  scale_y_continuous(limits = c(0, 40),
                     expand = c(0, 0)) +
  labs(x = " ",
       y = "Loss (%)") +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "top",
        panel.grid.minor.y = element_blank())
```

